<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›·åŠ¨ä¸‰åƒ - å°æ¸¸æˆå¤§å…</title>
<style>
:root {
    --bg-primary: #1e1e1e;
    --bg-secondary: #252526;
    --bg-hover: #2a2d2e;
    --text-primary: #cccccc;
    --text-secondary: #969696;
    --accent: #0078d4;
    --accent-hover: #1a8ae8;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
    --border: #3c3c3c;
    --radius: 6px;
}

.theme-light {
    --bg-primary: #ffffff;
    --bg-secondary: #f3f3f3;
    --bg-hover: #e8e8e8;
    --text-primary: #333333;
    --text-secondary: #666666;
    --accent: #0078d4;
    --border: #d4d4d4;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* â”€â”€â”€ é¡¶æ  â”€â”€â”€ */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}
.header h1 {
    font-size: 18px;
    font-weight: 600;
}
.header h1 span { font-size: 14px; color: var(--text-secondary); margin-left: 8px; }
.header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}
.status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger);
    transition: background 0.3s;
}
.status-dot.connected { background: var(--success); }
.player-name {
    font-size: 13px;
    color: var(--text-secondary);
}

/* â”€â”€â”€ æ³¨å†Œé¢æ¿ â”€â”€â”€ */
.register-panel {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.register-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 32px;
    width: 340px;
    text-align: center;
}
.register-card h2 {
    font-size: 20px;
    margin-bottom: 8px;
}
.register-card p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
}
.register-card input {
    width: 100%;
    padding: 10px 14px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    margin-bottom: 16px;
}
.register-card input:focus {
    border-color: var(--accent);
}

/* â”€â”€â”€ ä¸»ä½“ â”€â”€â”€ */
.main {
    flex: 1;
    display: flex;
    padding: 20px;
    gap: 20px;
    overflow: hidden;
}

/* â”€â”€â”€ æ¸¸æˆé€‰æ‹© â”€â”€â”€ */
.game-list {
    width: 240px;
    flex-shrink: 0;
}
.section-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 10px;
    letter-spacing: 0.5px;
}
.game-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-bottom: 8px;
}
.game-card:hover { background: var(--bg-hover); }
.game-card.active { border-color: var(--accent); }
.game-card .icon { font-size: 24px; margin-bottom: 6px; }
.game-card .name { font-size: 14px; font-weight: 500; }
.game-card .desc { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

/* â”€â”€â”€ æˆ¿é—´åˆ—è¡¨ â”€â”€â”€ */
.room-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.room-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}
.room-list {
    flex: 1;
    overflow-y: auto;
}
.room-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background 0.2s;
}
.room-item:hover { background: var(--bg-hover); }
.room-info .room-name { font-size: 14px; font-weight: 500; }
.room-info .room-meta {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 2px;
}
.room-status {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    margin-right: 8px;
}
.room-status.waiting { background: rgba(76,175,80,0.15); color: var(--success); }
.room-status.playing { background: rgba(255,152,0,0.15); color: var(--warning); }
.room-status.finished { background: rgba(150,150,150,0.15); color: var(--text-secondary); }

.empty-state {
    text-align: center;
    padding: 40px 0;
    color: var(--text-secondary);
    font-size: 14px;
}
.empty-state .icon { font-size: 48px; margin-bottom: 12px; }

/* â”€â”€â”€ æŒ‰é’® â”€â”€â”€ */
.btn {
    padding: 8px 16px;
    border-radius: var(--radius);
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
}
.btn-primary {
    background: var(--accent);
    color: #fff;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary {
    background: var(--bg-hover);
    color: var(--text-primary);
    border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { opacity: 0.85; }

/* â”€â”€â”€ åˆ›å»ºæˆ¿é—´å¼¹çª— â”€â”€â”€ */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
}
.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    width: 360px;
}
.modal h3 { margin-bottom: 16px; font-size: 16px; }
.modal label {
    font-size: 13px;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 6px;
}
.modal input {
    width: 100%;
    padding: 8px 12px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    margin-bottom: 16px;
}
.modal input:focus { border-color: var(--accent); }
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* â”€â”€â”€ åº•æ  â”€â”€â”€ */
.footer {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    padding: 6px 20px;
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    justify-content: space-between;
    flex-shrink: 0;
}

/* â”€â”€â”€ æ»šåŠ¨æ¡ â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

.hidden { display: none !important; }

/* â”€â”€â”€ èŠå¤©+åœ¨çº¿ç©å®¶é¢æ¿ â”€â”€â”€ */
.social-panel {
    width: 240px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex-shrink: 0;
    overflow: hidden;
}
.social-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.social-card-header {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    padding: 10px 12px 6px;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}
.online-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 8px 8px;
    font-size: 12px;
}
.online-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 4px;
}
.online-item:hover { background: var(--bg-hover); }
.online-dot {
    width: 6px; height: 6px; border-radius: 50%;
    flex-shrink: 0;
}
.online-dot.idle { background: var(--success); }
.online-dot.playing { background: var(--warning); }
.online-dot.waiting { background: var(--accent); }
.online-dot.spectating { background: #9c27b0; }
.online-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.online-status {
    font-size: 10px;
    color: var(--text-secondary);
    flex-shrink: 0;
}
.lobby-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
}
.lobby-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 4px 8px;
    font-size: 12px;
    min-height: 80px;
}
.lobby-chat-messages .chat-msg { padding: 2px 0; line-height: 1.5; word-break: break-all; }
.lobby-chat-messages .chat-msg .name { color: var(--accent); font-weight: 500; }
.lobby-chat-messages .chat-msg .time { color: var(--text-secondary); font-size: 10px; margin-right: 4px; opacity: 0.7; }
.lobby-chat-messages .chat-msg .sys { color: var(--text-secondary); font-style: italic; }
.lobby-chat-input {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
}
.lobby-chat-input input {
    flex: 1;
    padding: 5px 8px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 12px;
    outline: none;
}
.lobby-chat-input input:focus { border-color: var(--accent); }
.lobby-emoji-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 1px;
    padding: 4px 8px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.25s ease;
}
.lobby-emoji-picker.open { max-height: 100px; }
.lobby-emoji-btn {
    width: 24px; height: 24px;
    border: none; background: none;
    cursor: pointer; font-size: 14px;
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
}
.lobby-emoji-btn:hover { background: var(--bg-hover); }
.lobby-emoji-toggle {
    background: none; border: none; cursor: pointer;
    font-size: 14px; padding: 3px 5px; color: var(--text-secondary);
}
.lobby-emoji-toggle:hover { background: var(--bg-hover); border-radius: 4px; }
</style>
</head>
<body>

<!-- æ³¨å†Œé¢æ¿ -->
<div class="register-panel" id="registerPanel">
    <div class="register-card">
        <h2>ğŸ® é›·åŠ¨ä¸‰åƒ</h2>
        <p>å°æ¸¸æˆå¤§å… Â· è¾“å…¥æ˜µç§°å¼€å§‹</p>
        <input type="text" id="nameInput" placeholder="ä½ çš„æ˜µç§°" maxlength="20" autocomplete="off">
        <button class="btn btn-primary" style="width:100%" onclick="register()">è¿› å…¥</button>
    </div>
</div>

<!-- é¡¶æ  -->
<div class="header">
    <h1>ğŸ® é›·åŠ¨ä¸‰åƒ <span>å°æ¸¸æˆå¤§å…</span></h1>
    <div class="header-right">
        <div class="status-dot" id="statusDot" title="æœåŠ¡å™¨è¿æ¥çŠ¶æ€"></div>
        <span class="player-name" id="playerNameDisplay"></span>
        <span class="player-name" id="playerUidDisplay" style="font-size:10px;opacity:0.5"></span>
        <span style="font-size:12px;cursor:pointer;color:var(--accent)" onclick="changeNickname()" title="ä¿®æ”¹æ˜µç§°">âœï¸</span>
    </div>
</div>

<!-- ä¸»ä½“ -->
<div class="main">
    <!-- æ¸¸æˆé€‰æ‹© -->
    <div class="game-list">
        <div class="section-title">å¯é€‰æ¸¸æˆ</div>
        <div id="gameList"></div>
        <div style="margin-top:16px">
            <div class="section-title">ğŸ† æˆ‘çš„æˆ˜ç»©</div>
            <div id="playerStatsPanel" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-size:12px;color:var(--text-secondary)">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>

    <!-- æˆ¿é—´åˆ—è¡¨ -->
    <div class="room-panel">
        <div class="room-toolbar">
            <div class="section-title" style="margin-bottom:0">
                æˆ¿é—´åˆ—è¡¨ <span id="roomCount" style="color:var(--accent)"></span>
            </div>
            <div style="display:flex;gap:8px">
                <button class="btn btn-secondary btn-sm" onclick="refreshRooms()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-primary btn-sm" onclick="showCreateModal()">â• åˆ›å»ºæˆ¿é—´</button>
            </div>
        </div>
        <div class="room-list" id="roomList">
            <div class="empty-state">
                <div class="icon">ğŸ </div>
                <div>æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§</div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©+åœ¨çº¿ç©å®¶ -->
    <div class="social-panel">
        <!-- åœ¨çº¿ç©å®¶ -->
        <div class="social-card" style="max-height:180px">
            <div class="social-card-header">ğŸ‘¥ åœ¨çº¿ç©å®¶ <span id="onlineCount" style="color:var(--accent)"></span></div>
            <div class="online-list" id="onlineList">
                <div style="color:var(--text-secondary);padding:8px">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <!-- å¤§å…èŠå¤© -->
        <div class="social-card lobby-chat" style="flex:1">
            <div class="social-card-header">ğŸ’¬ å¤§å…èŠå¤©</div>
            <div class="lobby-chat-messages" id="lobbyChatMessages"></div>
            <div class="lobby-emoji-picker" id="lobbyEmojiPicker"></div>
            <div class="lobby-chat-input">
                <button class="lobby-emoji-toggle" onclick="toggleLobbyEmoji()" title="è¡¨æƒ…">ğŸ˜Š</button>
                <input type="text" id="lobbyChatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." maxlength="200">
                <button class="btn btn-primary btn-sm" onclick="sendLobbyChat()">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- åº•æ  -->
<div class="footer">
    <span>é›·åŠ¨ä¸‰åƒ Â· å°æ¸¸æˆå¹³å° v1.1</span>
    <span id="statsInfo">åœ¨çº¿: 0 | æˆ¿é—´: 0</span>
</div>

<!-- åˆ›å»ºæˆ¿é—´å¼¹çª— -->
<div class="modal-overlay hidden" id="createModal">
    <div class="modal">
        <h3>åˆ›å»ºæ¸¸æˆæˆ¿é—´</h3>
        <label>æˆ¿é—´åç§°</label>
        <input type="text" id="roomNameInput" placeholder="å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤" maxlength="20">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="hideCreateModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="createRoom()">åˆ›å»º</button>
        </div>
    </div>
</div>

<script>
// â”€â”€â”€ é…ç½® â”€â”€â”€
const CONFIG = window.__SERVER_CONFIG__ || {};
const WS_URL = CONFIG.wsUrl || `ws://${location.hostname}:8089`;
const THEME = CONFIG.theme || 'dark';
const SOURCE = CONFIG.source || 'browser';

if (THEME === 'light' || THEME === 'vscode-light') {
    document.body.classList.add('theme-light');
}

// â”€â”€â”€ çŠ¶æ€ â”€â”€â”€
let ws = null;
let playerName = CONFIG.playerName || localStorage.getItem('ld_playerName') || '';
let playerUid = CONFIG.uid || localStorage.getItem('ld_playerUid') || '';
let deviceHash = CONFIG.deviceHash || localStorage.getItem('ld_deviceHash') || '';
let selectedGame = 'gomoku';
let rooms = [];
let reconnectTimer = null;
let reconnectAttempts = 0;

// â”€â”€â”€ æ¸¸æˆåˆ—è¡¨ â”€â”€â”€
const GAMES = [
    { id: 'gomoku', name: 'äº”å­æ£‹', icon: 'âš«', desc: 'ç»å…¸åŒäººå¯¹å¼ˆï¼Œäº”å­è¿ç è·èƒœ' }
];

function showPlayerStats(stats) {
    const el = document.getElementById('playerStatsPanel');
    if (!el || !stats) return;
    el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 12px">
            <div>æ€»å±€æ•°: <strong style="color:var(--text-primary)">${stats.total_games || 0}</strong></div>
            <div>èƒœç‡: <strong style="color:var(--success)">${stats.win_rate || 0}%</strong></div>
            <div>èƒœ: <strong style="color:var(--success)">${stats.total_wins || 0}</strong></div>
            <div>è´Ÿ: <strong style="color:var(--danger)">${stats.total_losses || 0}</strong></div>
            <div>å¹³: <strong>${stats.total_draws || 0}</strong></div>
        </div>
    `;
}

function renderGameList() {
    const container = document.getElementById('gameList');
    container.innerHTML = GAMES.map(g => `
        <div class="game-card ${g.id === selectedGame ? 'active' : ''}" onclick="selectGame('${g.id}')">
            <div class="icon">${g.icon}</div>
            <div class="name">${g.name}</div>
            <div class="desc">${g.desc}</div>
        </div>
    `).join('');
}

function selectGame(id) {
    selectedGame = id;
    renderGameList();
    refreshRooms();
}

// â”€â”€â”€ æ³¨å†Œ â”€â”€â”€
function register() {
    const input = document.getElementById('nameInput');
    const name = input.value.trim();
    if (!name) { input.focus(); return; }
    playerName = name;
    document.getElementById('registerPanel').classList.add('hidden');
    updateHeaderInfo();
    connectWS();
}

function updateHeaderInfo() {
    document.getElementById('playerNameDisplay').textContent = playerName;
    if (playerUid) {
        document.getElementById('playerUidDisplay').textContent = 'UID:' + playerUid.substring(0, 8);
    }
}

// å¦‚æœå·²æœ‰æ˜µç§°ï¼ˆä»æ¸¸æˆé¡µè¿”å›æˆ–ä» VS Code è¿›å…¥ï¼‰ï¼Œè‡ªåŠ¨è·³è¿‡æ³¨å†Œé¢æ¿
if (playerName) {
    document.getElementById('nameInput').value = playerName;
    register();
}

document.getElementById('nameInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') register();
});

// â”€â”€â”€ ä¿®æ”¹æ˜µç§° â”€â”€â”€
function changeNickname() {
    // å¦‚æœåœ¨ VS Code WebView iframe å†…ï¼Œé€šçŸ¥çˆ¶çº§æ‰©å±•å¤„ç†
    if (SOURCE === 'vscode' && window.parent !== window) {
        window.parent.postMessage({ target: 'vscode', command: 'changeNickname' }, '*');
        return;
    }
    // çº¯æµè§ˆå™¨æ¨¡å¼ï¼šå¼¹å‡ºè¾“å…¥æ¡†
    const newName = prompt('è¾“å…¥æ–°æ˜µç§°:', playerName);
    if (newName && newName.trim()) {
        playerName = newName.trim();
        updateHeaderInfo();
        // é‡æ–°æ³¨å†Œï¼ˆuid ä¸å˜ï¼Œåªæ›´æ–°æ˜µç§°ï¼‰
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'register', playerName, uid: playerUid, deviceHash }));
        }
    }
}

// ç›‘å¬æ¥è‡ª VS Code çˆ¶çº§çš„æ¶ˆæ¯ï¼ˆæ˜µç§°å˜æ›´ï¼‰
window.addEventListener('message', (event) => {
    const msg = event.data;
    if (msg && msg.command === 'nicknameChanged' && msg.nickname) {
        playerName = msg.nickname;
        if (msg.uid) playerUid = msg.uid;
        updateHeaderInfo();
        // é‡æ–°æ³¨å†Œåˆ° WebSocket
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'register', playerName, uid: playerUid, deviceHash }));
        }
    }
});

// â”€â”€â”€ WebSocket â”€â”€â”€
function connectWS() {
    if (ws && ws.readyState === WebSocket.OPEN) return;

    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        reconnectAttempts = 0;
        document.getElementById('statusDot').classList.add('connected');
        // æ³¨å†Œï¼ˆæºå¸¦ uid å’Œ deviceHashï¼‰
        ws.send(JSON.stringify({ type: 'register', playerName, uid: playerUid, deviceHash }));
    };

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        handleMessage(data);
    };

    ws.onclose = () => {
        document.getElementById('statusDot').classList.remove('connected');
        scheduleReconnect();
    };

    ws.onerror = () => {
        // onclose ä¼šæ¥ç€è§¦å‘
    };
}

function scheduleReconnect() {
    if (reconnectTimer) return;
    reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000);
    reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connectWS();
    }, delay);
}

function sendMsg(data) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
    }
}

// â”€â”€â”€ æ¶ˆæ¯å¤„ç† â”€â”€â”€
function handleMessage(data) {
    switch (data.type) {
        case 'registered':
            playerName = data.playerName;
            if (data.uid) playerUid = data.uid;
            // æŒä¹…åŒ–åˆ° localStorage
            localStorage.setItem('ld_playerName', playerName);
            localStorage.setItem('ld_playerUid', playerUid);
            if (deviceHash) localStorage.setItem('ld_deviceHash', deviceHash);
            updateHeaderInfo();
            refreshRooms();
            // å¤„ç† uid å†²çª
            if (data.uidConflict && data.newUid) {
                playerUid = data.newUid;
                updateHeaderInfo();
                // é€šçŸ¥ VS Code æ‰©å±•ç¼“å­˜æ–° uid
                if (SOURCE === 'vscode' && window.parent !== window) {
                    window.parent.postMessage({ target: 'vscode', command: 'uidConflict', newUid: data.newUid }, '*');
                }
            }
            // æ˜¾ç¤ºæˆ˜ç»©
            if (data.stats) {
                showPlayerStats(data.stats);
            }
            // æ˜¾ç¤ºåœ¨çº¿ç©å®¶
            if (data.onlinePlayers) {
                renderOnlinePlayers(data.onlinePlayers);
            }
            break;

        case 'roomList':
            rooms = data.rooms || [];
            renderRooms();
            if (data.stats) {
                document.getElementById('statsInfo').textContent =
                    `åœ¨çº¿: ${data.stats.totalPlayers} | æˆ¿é—´: ${data.stats.totalRooms}`;
            }
            break;

        case 'onlinePlayers':
            renderOnlinePlayers(data.players || []);
            break;

        case 'lobbyChat':
            addLobbyChatMsg(data.playerName, data.message, data.time);
            break;

        case 'roomCreated':
            refreshRooms();
            // è‡ªåŠ¨è¿›å…¥å·²åˆ›å»ºçš„æˆ¿é—´ï¼ˆç­‰å¾…å¯¹æ‰‹ï¼‰
            showWaiting(data.room);
            break;

        case 'roomJoined':
            // åŠ å…¥äº†æˆ¿é—´ï¼Œç­‰å¾…æ¸¸æˆå¼€å§‹
            showWaiting(data.room);
            break;

        case 'playerJoined':
            // æœ‰äººåŠ å…¥æˆ‘çš„æˆ¿é—´
            break;

        case 'gameStart':
            // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
            goToGame(data);
            break;

        case 'ping':
            sendMsg({ type: 'pong' });
            break;

        case 'error':
            alert(data.message);
            break;
    }
}

// â”€â”€â”€ æˆ¿é—´æ“ä½œ â”€â”€â”€
function refreshRooms() {
    sendMsg({ type: 'roomList', gameType: selectedGame });
}

function getPlayerNames(players) {
    // players å¯èƒ½æ˜¯ [{name, uid}, ...] æˆ– ["åå­—", ...]
    if (!players || players.length === 0) return 'ç©º';
    return players.map(p => typeof p === 'object' ? escapeHtml(p.name) : escapeHtml(p)).join(', ');
}

function renderRooms() {
    const container = document.getElementById('roomList');
    const filtered = rooms.filter(r => !selectedGame || r.gameType === selectedGame);
    document.getElementById('roomCount').textContent = `(${filtered.length})`;

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ </div>
                <div>æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§</div>
            </div>`;
        return;
    }

    container.innerHTML = filtered.map(room => `
        <div class="room-item">
            <div class="room-info">
                <div class="room-name">${escapeHtml(room.name)}</div>
                <div class="room-meta">
                    ${GAMES.find(g => g.id === room.gameType)?.icon || 'ğŸ®'} ${room.gameType}
                    Â· ${getPlayerNames(room.players)}
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
                <span class="room-status ${room.status}">${
                    room.status === 'waiting' ? 'ç­‰å¾…ä¸­' :
                    room.status === 'playing' ? 'æ¸¸æˆä¸­' : 'å·²ç»“æŸ'
                }</span>
                <span style="font-size:13px;color:var(--text-secondary)">${room.playerCount}/${room.maxPlayers}${room.spectatorCount ? ' ğŸ‘' + room.spectatorCount : ''}</span>
                ${room.status === 'waiting' && room.playerCount < room.maxPlayers
                    ? `<button class="btn btn-primary btn-sm" onclick="joinRoom('${room.id}')">åŠ å…¥</button>`
                    : ''
                }
                ${room.status === 'playing'
                    ? `<button class="btn btn-sm" style="background:rgba(255,152,0,0.15);color:var(--warning);border:1px solid var(--warning);cursor:pointer;padding:4px 10px;border-radius:4px;font-size:12px" onclick="spectateRoom('${room.id}')">ğŸ‘ è§‚æˆ˜</button>`
                    : ''
                }
            </div>
        </div>
    `).join('');
}

function showCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
    document.getElementById('roomNameInput').focus();
}

function hideCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
}

function createRoom() {
    const name = document.getElementById('roomNameInput').value.trim();
    sendMsg({
        type: 'createRoom',
        gameType: selectedGame,
        roomName: name
    });
    hideCreateModal();
}

function joinRoom(roomId) {
    sendMsg({ type: 'joinRoom', roomId });
}

function spectateRoom(roomId) {
    // ä»¥è§‚æˆ˜æ¨¡å¼è·³è½¬åˆ°æ¸¸æˆé¡µé¢
    const gameUrl = `/games/gomoku.html?wsUrl=${encodeURIComponent(WS_URL)}&playerName=${encodeURIComponent(playerName)}&uid=${encodeURIComponent(playerUid)}&deviceHash=${encodeURIComponent(deviceHash)}&theme=${THEME}&spectate=true&roomId=${encodeURIComponent(roomId)}`;
    window.location.href = gameUrl;
}

// â”€â”€â”€ ç­‰å¾…é¡µé¢ â”€â”€â”€
function showWaiting(room) {
    document.querySelector('.main').innerHTML = `
        <div style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column">
            <div style="font-size:48px;margin-bottom:16px">â³</div>
            <h2 style="margin-bottom:8px">${escapeHtml(room.name)}</h2>
            <p style="color:var(--text-secondary);margin-bottom:24px">
                ç­‰å¾…å¯¹æ‰‹åŠ å…¥... (${room.playerCount}/${room.maxPlayers})
            </p>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:24px">
                æˆ¿é—´ID: ${room.id}
            </p>
            <button class="btn btn-danger btn-sm" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
        </div>
    `;
}

function leaveRoom() {
    sendMsg({ type: 'leaveRoom' });
    location.reload();
}

// â”€â”€â”€ è·³è½¬æ¸¸æˆ â”€â”€â”€
function goToGame(data) {
    // å°†æ¸¸æˆä¿¡æ¯å­˜å…¥ sessionStorageï¼Œç„¶åè·³è½¬
    sessionStorage.setItem('gameData', JSON.stringify({
        roomId: data.roomId,
        yourColor: data.yourColor,
        state: data.state,
        wsUrl: WS_URL,
        playerName: playerName,
        uid: playerUid,
        deviceHash: deviceHash,
        theme: THEME,
    }));

    // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
    const gameUrl = `/games/${data.gameType}.html?wsUrl=${encodeURIComponent(WS_URL)}&playerName=${encodeURIComponent(playerName)}&uid=${encodeURIComponent(playerUid)}&deviceHash=${encodeURIComponent(deviceHash)}&theme=${THEME}`;
    window.location.href = gameUrl;
}

// â”€â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// â”€â”€â”€ åœ¨çº¿ç©å®¶ â”€â”€â”€
function renderOnlinePlayers(players) {
    const el = document.getElementById('onlineList');
    const countEl = document.getElementById('onlineCount');
    if (!el) return;
    countEl.textContent = `(${players.length})`;

    if (players.length === 0) {
        el.innerHTML = '<div style="color:var(--text-secondary);padding:8px;font-size:12px">æš‚æ— åœ¨çº¿ç©å®¶</div>';
        return;
    }

    const statusLabel = { idle: 'å¤§å…', playing: 'æ¸¸æˆä¸­', waiting: 'ç­‰å¾…ä¸­', spectating: 'è§‚æˆ˜ä¸­' };
    el.innerHTML = players.map(p => `
        <div class="online-item">
            <div class="online-dot ${p.status}"></div>
            <span class="online-name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</span>
            <span class="online-status">${statusLabel[p.status] || ''}</span>
        </div>
    `).join('');
}

// â”€â”€â”€ å¤§å…èŠå¤© â”€â”€â”€
const LOBBY_EMOJIS = [
    'ğŸ˜„','ğŸ˜‚','ğŸ˜Š','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ˜¤','ğŸ˜¢','ğŸ¤£','ğŸ˜ˆ',
    'ğŸ‘','ğŸ‘','ğŸ‰','ğŸ”¥','ğŸ’ª','ğŸ†','ğŸ‘€','ğŸ¯','ğŸ’€','â¤ï¸',
    'ğŸ™','ğŸ˜','ğŸ¥³','ğŸ˜œ','ğŸ¤—','ğŸ˜±','ğŸ¥º','ğŸ˜','ğŸ¤©','ğŸ«¡',
    'âœŒï¸','ğŸ‘‹','ğŸ¤','ğŸ’¯','ğŸ®','âš¡','ğŸŒŸ','ğŸ€','ğŸ« ','ğŸ¤¯',
    'ğŸ˜‡','ğŸ±','ğŸ¶','ğŸ¦Š','ğŸ¼','ğŸ¸','ğŸŒˆ','â˜€ï¸','ğŸŒ™','ğŸ•'
];

function initLobbyEmoji() {
    const picker = document.getElementById('lobbyEmojiPicker');
    if (!picker) return;
    picker.innerHTML = LOBBY_EMOJIS.map(e =>
        `<button class="lobby-emoji-btn" onclick="sendLobbyEmoji('${e}')">${e}</button>`
    ).join('');
}

function toggleLobbyEmoji() {
    document.getElementById('lobbyEmojiPicker').classList.toggle('open');
}

function sendLobbyEmoji(emoji) {
    sendMsg({ type: 'lobbyChat', message: emoji });
    document.getElementById('lobbyEmojiPicker').classList.remove('open');
}

function addLobbyChatMsg(name, msg, time) {
    const el = document.getElementById('lobbyChatMessages');
    if (!el) return;
    const timeStr = time || new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const isMe = name === playerName;
    el.innerHTML += `<div class="chat-msg"><span class="time">${timeStr}</span><span class="name" style="${isMe ? 'color:var(--success)' : ''}">${escapeHtml(name)}</span>: ${escapeHtml(msg)}</div>`;
    el.scrollTop = el.scrollHeight;
}

function addLobbySystemChat(msg) {
    const el = document.getElementById('lobbyChatMessages');
    if (!el) return;
    const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    el.innerHTML += `<div class="chat-msg"><span class="time">${time}</span><span class="sys">${escapeHtml(msg)}</span></div>`;
    el.scrollTop = el.scrollHeight;
}

function sendLobbyChat() {
    const input = document.getElementById('lobbyChatInput');
    const msg = input.value.trim();
    if (!msg) return;
    sendMsg({ type: 'lobbyChat', message: msg });
    input.value = '';
}

document.getElementById('lobbyChatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendLobbyChat();
});

// â”€â”€â”€ å®šæ—¶åˆ·æ–° â”€â”€â”€
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        refreshRooms();
    }
}, 5000);

// â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€
initLobbyEmoji();
renderGameList();
</script>
</body>
</html>

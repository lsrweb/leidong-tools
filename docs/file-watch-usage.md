# HTML→JS 文件监听功能使用说明

## 功能概述

此功能用于监听 HTML 文件变化，自动提取特定内容并更新对应的 JS 文件中的 `var html =` 变量。

**v2.1.3 更新**：完全重构，不再繁琐提示，支持一键批量启动多个项目监听。

## 使用方法

### 1. 方式一：右键菜单快速启动

**用于快速启动右键选中的文件夹监听**

1. 在 VSCode 资源管理器中，右键点击要监听的文件夹
2. 选择 **"启动 HTML→JS 文件监听"**
3. 系统自动识别目录结构：
   - ✅ 如果是单个项目（包含 `dev/` 子目录）：直接启动监听
   - ✅ 如果是多项目容器（如 `static/h5/` 包含多个项目）：弹出 QuickPick 下拉菜单

**QuickPick 下拉菜单说明**：
- 显示所有检测到的项目（默认全选）
- 支持鼠标或空格键勾选/取消 checkbox
- 提供"全选全部"和"全部取消"快捷按钮
- 按 Enter 确认启动

### 2. 方式二：手动搜索面板（推荐用于复杂目录结构）

**用于手动选择任意工作区路径并启动监听**

1. 打开命令面板：`Ctrl+Shift+P`
2. 输入命令：`启动 HTML→JS 文件监听（手动选择）` 或 `leidong-tools.startWatchManual`
3. 弹出"选择文件夹"对话框
4. 选择任意工作区目录（支持多层级）
5. 系统自动递归扫描并识别内部的所有项目
6. QuickPick 显示可用项目，支持 checkbox 多选
7. 按 Enter 启动选中项目的监听

### 3. 查看监听状态

启动监听后，VSCode 底部状态栏右侧会显示一个眼睛图标 `👁️ N`（N 表示当前监听的数量）。

点击图标可以：
- 查看所有正在监听的目录
- 停止指定的监听
- 停止所有监听

## 目录结构识别规则

### 支持的目录结构

系统支持三种常见的项目目录结构：

#### 1. 单项目结构
```
项目名/
  ├── dev/           ← 监听这个
  │   ├── index.html
  │   └── index.js
  └── src/
      └── ...
```
**识别方式**：右键选择 `项目名/` → 自动找到 `dev/` 并启动监听

#### 2. 项目本身就是 dev 目录
```
项目名-dev/        ← 直接选择这个
  ├── index.html
  └── index.js
```
**识别方式**：右键选择 `项目名-dev/` → 直接启动监听该目录

#### 3. 多项目容器结构（推荐用手动搜索）
```
static/                   ← 推荐手动搜索这个
├── h5/
│   ├── lease-user-binding/
│   │   └── dev/
│   ├── lease-user-index/
│   │   └── dev/
│   ├── score-mall-detail/
│   │   └── dev/
│   └── ... (20+ 个项目)
└── mini/
    ├── project-a/
    │   └── dev/
    └── ... (更多项目)
```

**识别方式**：
- ✅ 手动搜索 `static/` → 系统自动扫描所有项目
- ✅ 递归深度最多 3 层（防止过度扫描）
- ✅ QuickPick 列出所有项目，checkbox 多选启动

## 工作原理

当被监听的 HTML 文件发生变化时，系统会：

### 1. 提取 HTML 内容

支持两种方式（优先级顺序）：

**方式一（优先）**：提取两个注释标记之间的内容
```html
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
<div>您的内容</div>
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
```

**方式二（备选）**：提取 `id="vm"` 的 `<div>` 元素
```html
<div id="vm">
  您的内容
</div>
```

### 2. 处理 HTML 内容

- 将单引号 `'` 转义为 `\'`
- 将 `&amp;&amp;` 还原为 `&&`（保持 Vue 条件判断正常）
- 压缩为单行（去除换行和多余空格）

### 3. 更新 JS 文件

- 在同目录下查找所有 `.js` 文件
- 找到包含 `var html =` 的行
- 替换为 `var html = '处理后的HTML内容';`

### 4. 显示通知

- 成功时显示：`✅ 项目名: 已更新 N 个 JS 文件`

## 防重复监听机制

系统会自动检测监听冲突：

**场景1：子目录已监听，尝试监听父目录**
```
父目录/
  └── 项目/
      └── dev/     ← 已监听
```
如果尝试监听 `父目录` 或 `项目`，会提示冲突

**场景2：父目录已监听，尝试监听子目录**
```
项目/              ← 已监听
  └── dev/
```
如果尝试监听 `dev`，会提示冲突

## 使用示例

### 示例 1：单项目监听

**右键选择项目文件夹**

项目结构：
```
my-project/
  └── dev/
      ├── index.html
      └── index.js
```

步骤：
1. 在 VSCode 资源管理器右键 `my-project/`
2. 选择"启动 HTML→JS 文件监听"
3. 系统自动检测到 `dev/` 目录并启动监听
4. 状态栏显示 `👁️ 1`

### 示例 2：多项目容器批量启动

**手动搜索或右键选择容器目录**

项目结构：
```
static/
└── h5/
    ├── lease-user-binding/
    │   └── dev/
    ├── lease-user-index/
    │   └── dev/
    ├── score-mall-detail/
    │   └── dev/
    └── ... (20+ 个项目)
```

**方式 A：右键选择 `static/`**
1. 右键 `static/` 文件夹
2. 选择"启动 HTML→JS 文件监听"
3. QuickPick 弹出显示所有项目（默认全选）
4. 可用 checkbox 多选/取消
5. 按 Enter 一次启动 20+ 个项目监听

**方式 B：手动搜索（推荐）**
1. 命令面板输入"手动启动监听"
2. 选择 `static/` 目录
3. 系统递归扫描所有项目
4. QuickPick 显示所有可用项目
5. checkbox 多选启动

**默认全选提示**：
```
✨ 发现 23 个项目，请选择要监听的项目（支持多选）
☑ $(folder) lease-user-binding
☑ $(folder) lease-user-index
☑ $(folder) score-mall-detail
☑ $(folder) score-mall-list
... (更多项目)
☐ $(check-all) 全选全部
☐ $(close-all) 全部取消
```

按 Enter 后状态栏显示：`👁️ 23`

### 示例 3：HTML 文件自动更新

**index.html (变化前)**
```html
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
<div id="vm">
  <h1 v-if="show && active">标题</h1>
  <p>{{ message }}</p>
</div>
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
```

**index.js (自动更新前)**
```javascript
var html = '';
var vm = new Vue({...});
```

**index.js (自动更新后)**
```javascript
var html = '<div id=\"vm\"><h1 v-if=\"show && active\">标题</h1><p>{{ message }}</p></div>';
var vm = new Vue({...});
```

## 状态栏说明

| 图标 | 含义 |
|------|------|
| `👁️ 1` | 正在监听 1 个目录 |
| `👁️ 23` | 正在监听 23 个目录 |
| `👁️ 0` 或无图标 | 没有正在进行的监听 |

## 停止监听

**方式一：通过状态栏**
1. 点击底部状态栏的 `👁️ N` 图标
2. QuickPick 显示所有监听项
3. 选择要停止的项或"停止所有监听"

**方式二：通过命令面板**
1. 按 `Ctrl+Shift+P`
2. 输入 `查看/管理文件监听列表`
3. 选择操作

## 注意事项

1. **文件命名规范**：JS 文件必须包含 `var html =` 语句
2. **HTML 提取方式**：优先使用注释标记，其次是 `id="vm"` 的 div
3. **特殊字符处理**：
   - 单引号会被转义为 `\'`
   - `&&` 会被保留（不会变成 `&amp;&amp;`）
4. **监听范围**：只监听 dev 目录下的文件，不递归子目录
5. **性能考虑**：
   - 使用异步 I/O，不阻塞主线程
   - 递归扫描最多 3 层
   - 跳过无权限目录

## 常见问题

### Q1: 为什么更新没有生效？
**A:** 检查以下几点：
- JS 文件中是否有 `var html =` 语句
- HTML 文件是否包含正确的标记或 `id="vm"` 的 div
- 查看 VSCode 输出面板的日志信息

### Q2: 可以同时监听多个项目吗？
**A:** 可以！每个项目独立监听，互不干扰。状态栏会显示总监听数量。
- 一个项目一个监听项
- 支持 20+ 项目同时监听
- 性能不受影响（异步处理）

### Q3: 监听会影响编辑器性能吗？
**A:** 不会。使用 VSCode 原生的 FileSystemWatcher，性能开销很小。只在文件变化时触发处理。

### Q4: 如何查看监听日志？
**A:** 打开 VSCode 开发者工具：
- 菜单 `Help` > `Toggle Developer Tools`
- 查看 Console 面板
- 所有日志都带有项目名前缀：`[FileWatch]`、`[项目名]`

### Q5: 支持哪些文件类型？
**A:** 目前默认监听 `html` 文件。如需监听其他类型（如 `htm`），请提交 issue。

## 版本历史

### v2.1.3 (2025-10-19)
- 🎯 完全重构文件监听功能
- ✨ 移除繁琐提示，不再询问文件扩展名
- 📋 支持 checkbox 多选面板
- 🔍 新增手动搜索命令
- ⚡ 异步处理，不阻塞主线程
- ✅ 修复 undefined 错误

### v2.1.2 (2025-10-09)
- 🐛 修复 WebView 资源打包问题
- 📦 支持多 script 标签解析
- 🎨 修复样式崩溃

### v1.1.6 (发布版本)
- 🎉 首次发布 HTML→JS 文件监听功能
- ✨ 支持右键菜单启动监听
- ✨ 状态栏显示监听状态
- ✨ 智能目录识别（dev 目录）
- ✨ 防重复监听机制

# HTML→JS 文件监听功能使用说明

## 功能概述

此功能用于监听 HTML 文件变化，自动提取特定内容并更新对应的 JS 文件中的 `var html =` 变量。

## 使用方法

### 1. 启动监听

**方式一：通过右键菜单**
1. 在 VSCode 资源管理器中，右键点击要监听的文件夹
2. 选择 **"启动 HTML→JS 文件监听"**
3. 输入要监听的文件扩展名（默认：html），可以用逗号分隔多个扩展名，如：`html,htm`
4. 系统会自动确定监听目录（详见下文"目录识别规则"）

**方式二：通过命令面板**
1. 按 `Ctrl+Shift+P` 打开命令面板
2. 输入 `启动 HTML→JS 文件监听`
3. 选择文件夹并输入文件扩展名

### 2. 查看监听状态

启动监听后，VSCode 底部状态栏右侧会显示一个眼睛图标 `👁️ N`（N 表示当前监听的数量）。

点击图标可以：
- 查看所有正在监听的目录
- 停止指定的监听
- 停止所有监听

### 3. 监听工作原理

当被监听的 HTML 文件发生变化时，系统会：

1. **提取 HTML 内容**（两种方式）：
   - **方式一**（优先）：提取两个注释标记之间的内容
     ```html
     <!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
     <div>您的内容</div>
     <!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
     ```
   
   - **方式二**（备选）：提取 `id="vm"` 的 `<div>` 元素
     ```html
     <div id="vm">
       您的内容
     </div>
     ```

2. **处理 HTML 内容**：
   - 将单引号 `'` 转义为 `\'`
   - 将 `&amp;&amp;` 还原为 `&&`（保持 Vue 条件判断正常）
   - 压缩为单行（去除换行和多余空格）

3. **更新 JS 文件**：
   - 在同目录下查找所有 `.js` 文件
   - 找到包含 `var html =` 的行
   - 替换为 `var html = '处理后的HTML内容';`

4. **显示通知**：
   - 成功时显示：`✅ 项目名: 已更新 N 个 JS 文件`

## 目录识别规则

系统会根据选择的文件夹自动确定监听哪个目录：

### 情况1：直接选择 `dev` 目录
```
项目名/
  └── dev/          ← 选择这个
      ├── index.html
      └── index.js
```
**结果**：直接监听该 `dev` 目录

### 情况2：选择包含 `dev` 子目录的项目目录
```
项目名/            ← 选择这个
  └── dev/
      ├── index.html
      └── index.js
```
**结果**：自动监听 `项目名/dev` 目录

### 情况3：选择包含多个项目的父目录
```
父目录/            ← 选择这个
  ├── 项目A/
  │   └── dev/
  ├── 项目B/
  │   └── dev/
  └── 项目C/
      └── dev/
```
**结果**：让你选择要监听哪个项目的 `dev` 目录

### 情况4：没有 `dev` 子目录
```
某目录/            ← 选择这个
  ├── src/
  └── dist/
```
**结果**：显示警告，无法启动监听

## 防重复监听机制

系统会自动检测监听冲突：

**场景1：子目录已监听，尝试监听父目录**
```
父目录/
  └── 项目/
      └── dev/     ← 已监听
```
如果尝试监听 `父目录` 或 `项目`，会提示：
> ⚠️ 子目录 "项目" 已在监听中，是否继续？

**场景2：父目录已监听，尝试监听子目录**
```
项目/              ← 已监听
  └── dev/
```
如果尝试监听 `dev`，会提示：
> ⚠️ 父目录 "项目" 已在监听中，是否继续？

## 使用示例

### 示例 1：单项目监听

**项目结构：**
```
my-project/
  └── dev/
      ├── index.html
      └── index.js
```

**index.html:**
```html
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
<div id="vm">
  <h1 v-if="show && active">标题</h1>
  <p>{{ message }}</p>
</div>
<!-- 这部分要以字符串放在js中，注意里边的单引号需要替换为\' -->
```

**index.js (更新前):**
```javascript
var html = '';
var vm = new Vue({...});
```

**index.js (自动更新后):**
```javascript
var html = '<div id="vm"><h1 v-if="show && active">标题</h1><p>{{ message }}</p></div>';
var vm = new Vue({...});
```

### 示例 2：多项目监听

右键选择父目录 `projects/`，系统会扫描所有子项目并让你选择要监听哪个。

## 状态栏说明

| 图标 | 含义 |
|------|------|
| `👁️ 1` | 正在监听 1 个目录 |
| `👁️ 3` | 正在监听 3 个目录 |
| （无图标） | 没有正在进行的监听 |

## 停止监听

**方式一：通过状态栏**
1. 点击底部状态栏的 `👁️ N` 图标
2. 选择要停止的监听项
3. 或选择 "停止所有监听"

**方式二：通过命令面板**
1. 按 `Ctrl+Shift+P`
2. 输入 `查看/管理文件监听列表`
3. 选择操作

## 注意事项

1. **文件命名规范**：JS 文件必须包含 `var html =` 语句
2. **HTML 提取方式**：优先使用注释标记，其次是 `id="vm"` 的 div
3. **特殊字符处理**：
   - 单引号会被转义为 `\'`
   - `&&` 会被保留（不会变成 `&amp;&amp;`）
4. **监听范围**：只监听 dev 目录下的文件，不递归子目录
5. **性能考虑**：监听项过多可能影响性能，建议根据需要启停

## 常见问题

### Q1: 为什么更新没有生效？
**A:** 检查以下几点：
- JS 文件中是否有 `var html =` 语句
- HTML 文件是否包含正确的标记或 `id="vm"` 的 div
- 查看 VSCode 输出面板的日志信息

### Q2: 可以同时监听多个项目吗？
**A:** 可以！每个项目独立监听，互不干扰。状态栏会显示总监听数量。

### Q3: 监听会影响编辑器性能吗？
**A:** 使用 VSCode 原生的 FileSystemWatcher，性能开销很小。只在文件变化时触发处理。

### Q4: 如何查看监听日志？
**A:** 打开 VSCode 开发者工具（`Help` > `Toggle Developer Tools`），查看 Console 面板，所有日志都带有项目名前缀。

## 技术细节

- **监听器**：使用 `vscode.workspace.createFileSystemWatcher`
- **文件操作**：使用 Node.js 原生 `fs` 模块
- **HTML 解析**：纯正则表达式解析，支持嵌套标签
- **冲突检测**：基于路径前缀匹配
- **状态管理**：使用 Map 存储监听项

## 版本历史

### v1.1.6
- 🎉 首次发布 HTML→JS 文件监听功能
- ✨ 支持右键菜单启动监听
- ✨ 状态栏显示监听状态
- ✨ 智能目录识别（dev 目录）
- ✨ 防重复监听机制
- ✨ 可视化监听管理面板
